# ============================
# ğŸ“Š Upload de Arquivos CSV para o Google Cloud Storage via Google Colab
# Autor: [Seu Nome]
# DescriÃ§Ã£o: Este notebook permite importar arquivos .csv e um arquivo .json de credenciais 
# do Google Cloud, e realizar o upload dos arquivos CSV para um bucket no GCS.
# ============================

# ----------------------------------------
# ğŸ”§ 1. InstalaÃ§Ã£o da biblioteca do Google Cloud Storage
# ----------------------------------------

# Instalando a biblioteca necessÃ¡ria para trabalhar com Google Cloud Storage
!pip install --quiet google-cloud-storage

# ----------------------------------------
# ğŸ“‚ 2. Upload de Arquivos CSV locais
# ----------------------------------------

from google.colab import files

# Permite ao usuÃ¡rio fazer upload de um ou mais arquivos CSV do seu computador
uploaded = files.upload()

# Exibe os nomes dos arquivos que foram carregados
print("\nğŸ“„ Arquivos carregados:")
for nome in uploaded.keys():
    print(f" - {nome}")

# ----------------------------------------
# ğŸ” 3. Upload do JSON de credenciais da conta de serviÃ§o do GCP
# ----------------------------------------

print("ğŸ” Agora faÃ§a upload do arquivo .json de credenciais da conta de serviÃ§o do Google Cloud:")
uploaded_json = files.upload()

# Verifica se foi feito upload de um arquivo .json
json_cred = None
for fname in uploaded_json.keys():
    if fname.endswith(".json"):
        json_cred = fname

# Interrompe a execuÃ§Ã£o caso o JSON de credenciais nÃ£o tenha sido enviado
if not json_cred:
    raise Exception("âŒ Nenhum arquivo .json de credenciais foi enviado!")

# Define a variÃ¡vel de ambiente para autenticaÃ§Ã£o com o Google Cloud
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = json_cred

print(f"âœ… JSON de credenciais carregado: {json_cred}")

# ----------------------------------------
# â˜ï¸ 4. Upload dos arquivos CSV para o Google Cloud Storage
# ----------------------------------------

from google.cloud import storage

# Nome do bucket de destino no GCS (ajuste conforme seu projeto)
bucket_name = "projeto-bi"

# Caminho (pasta) dentro do bucket onde os arquivos serÃ£o armazenados
pasta_destino = "transacoes/"

# Cria o cliente do GCS usando as credenciais fornecidas
client = storage.Client()

# Lista apenas os arquivos CSV presentes no ambiente do Colab
arquivos_csv_no_colab = [f for f in os.listdir() if f.endswith('.csv')]

# Mostra os arquivos que podem ser enviados
print("ğŸ“‚ Arquivos disponÃ­veis no ambiente:")
for i, nome in enumerate(arquivos_csv_no_colab):
    print(f"[{i}] {nome}")

# ----------------------------------------
# âœï¸ 5. Selecione quais arquivos serÃ£o enviados
# ----------------------------------------

# Altere os Ã­ndices abaixo conforme os arquivos que deseja subir
# Exemplo: [0, 2] para subir o primeiro e o terceiro arquivo
indices_escolhidos = [0, 1]  # << MODIFIQUE AQUI se necessÃ¡rio

# Realiza o upload dos arquivos selecionados para o bucket no GCS
bucket = client.bucket(bucket_name)
for i in indices_escolhidos:
    nome_arquivo = arquivos_csv_no_colab[i]
    blob = bucket.blob(pasta_destino + nome_arquivo)
    blob.upload_from_filename(nome_arquivo)
    print(f"âœ… {nome_arquivo} enviado para gs://{bucket_name}/{pasta_destino}{nome_arquivo}")
