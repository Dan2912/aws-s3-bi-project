# ============================
# 📊 Upload de Arquivos CSV para o Google Cloud Storage via Google Colab
# Autor: [Seu Nome]
# Descrição: Este notebook permite importar arquivos .csv e um arquivo .json de credenciais 
# do Google Cloud, e realizar o upload dos arquivos CSV para um bucket no GCS.
# ============================

# ----------------------------------------
# 🔧 1. Instalação da biblioteca do Google Cloud Storage
# ----------------------------------------

# Instalando a biblioteca necessária para trabalhar com Google Cloud Storage
!pip install --quiet google-cloud-storage

# ----------------------------------------
# 📂 2. Upload de Arquivos CSV locais
# ----------------------------------------

from google.colab import files

# Permite ao usuário fazer upload de um ou mais arquivos CSV do seu computador
uploaded = files.upload()

# Exibe os nomes dos arquivos que foram carregados
print("\n📄 Arquivos carregados:")
for nome in uploaded.keys():
    print(f" - {nome}")

# ----------------------------------------
# 🔐 3. Upload do JSON de credenciais da conta de serviço do GCP
# ----------------------------------------

print("🔐 Agora faça upload do arquivo .json de credenciais da conta de serviço do Google Cloud:")
uploaded_json = files.upload()

# Verifica se foi feito upload de um arquivo .json
json_cred = None
for fname in uploaded_json.keys():
    if fname.endswith(".json"):
        json_cred = fname

# Interrompe a execução caso o JSON de credenciais não tenha sido enviado
if not json_cred:
    raise Exception("❌ Nenhum arquivo .json de credenciais foi enviado!")

# Define a variável de ambiente para autenticação com o Google Cloud
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = json_cred

print(f"✅ JSON de credenciais carregado: {json_cred}")

# ----------------------------------------
# ☁️ 4. Upload dos arquivos CSV para o Google Cloud Storage
# ----------------------------------------

from google.cloud import storage

# Nome do bucket de destino no GCS (ajuste conforme seu projeto)
bucket_name = "projeto-bi"

# Caminho (pasta) dentro do bucket onde os arquivos serão armazenados
pasta_destino = "transacoes/"

# Cria o cliente do GCS usando as credenciais fornecidas
client = storage.Client()

# Lista apenas os arquivos CSV presentes no ambiente do Colab
arquivos_csv_no_colab = [f for f in os.listdir() if f.endswith('.csv')]

# Mostra os arquivos que podem ser enviados
print("📂 Arquivos disponíveis no ambiente:")
for i, nome in enumerate(arquivos_csv_no_colab):
    print(f"[{i}] {nome}")

# ----------------------------------------
# ✏️ 5. Selecione quais arquivos serão enviados
# ----------------------------------------

# Altere os índices abaixo conforme os arquivos que deseja subir
# Exemplo: [0, 2] para subir o primeiro e o terceiro arquivo
indices_escolhidos = [0, 1]  # << MODIFIQUE AQUI se necessário

# Realiza o upload dos arquivos selecionados para o bucket no GCS
bucket = client.bucket(bucket_name)
for i in indices_escolhidos:
    nome_arquivo = arquivos_csv_no_colab[i]
    blob = bucket.blob(pasta_destino + nome_arquivo)
    blob.upload_from_filename(nome_arquivo)
    print(f"✅ {nome_arquivo} enviado para gs://{bucket_name}/{pasta_destino}{nome_arquivo}")
